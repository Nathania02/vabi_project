<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>GDP & GINI Comparison: Global vs Top 5 Economies | VABI Project</title>

		<!-- Bootstrap 5.3.x -->
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>

		<!-- D3.js v7 -->
		<script src="https://d3js.org/d3.v7.min.js"></script>

		<!-- TopoJSON v3 -->
		<script src="https://unpkg.com/topojson@3"></script>

		<style>
			body {
				font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
				background-color: #f8f9fa;
				color: #333;
				min-height: 100vh;
				display: flex;
				flex-direction: column;
			}

			.navbar {
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				background-color: white !important;
			}

			/* Multi-level dropdown styling */
			.dropdown-submenu {
				position: relative;
			}

			.dropdown-submenu .dropdown-menu {
				position: absolute;
				top: 0;
				left: 100%;
				margin-top: -1px;
				margin-left: -1px;
				max-height: 80vh;
				overflow-y: auto;
				min-width: 200px;
				width: max-content;
				max-width: 300px;
			}

			.dropdown-submenu.dropstart .dropdown-menu {
				left: auto;
				right: 100%;
				margin-left: 0;
				margin-right: -1px;
			}

			.dropdown-submenu:hover > .dropdown-menu {
				display: block;
			}

			.dropdown-item.has-submenu {
				position: relative;
				padding-right: 2rem;
			}

			.dropdown-item.has-submenu::after {
				content: "‚Ä∫";
				position: absolute;
				right: 1rem;
				font-weight: bold;
			}

			.dropdown-submenu.dropstart .dropdown-item.has-submenu::after {
				content: "‚Äπ";
			}

			body {
				overflow-x: hidden;
			}

			.content-wrapper {
				max-width: 1400px;
				margin: 0 auto;
				padding: 20px;
			}

			.breadcrumb-nav {
				background-color: #f8f9fa;
				padding: 15px 0;
				margin-bottom: 20px;
			}

			.hero-section {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				padding: 60px 20px;
				text-align: center;
				border-radius: 8px;
				margin-bottom: 30px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
				color: white;
			}

			.hero-section h1 {
				font-size: 2.5rem;
				font-weight: 700;
				margin-bottom: 0.5rem;
			}

			.hero-section p {
				font-size: 1.1rem;
				opacity: 0.95;
			}

			.card {
				background: white;
				border: none;
				border-radius: 8px;
				margin-bottom: 30px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}

			.card-header {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				border-bottom: none;
				font-weight: 600;
				font-size: 1.2rem;
				padding: 20px;
				border-radius: 8px 8px 0 0;
			}

			.card-body {
				padding: 30px;
			}

			.controls {
				display: flex;
				align-items: center;
				gap: 20px;
				margin-bottom: 20px;
				flex-wrap: wrap;
			}

			.year-control {
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.year-control label {
				font-weight: 600;
				color: #667eea;
				font-size: 0.95rem;
				white-space: nowrap;
			}

			.year-slider {
				width: 300px;
				height: 8px;
				border-radius: 4px;
				background: #e9ecef;
				outline: none;
				-webkit-appearance: none;
				appearance: none;
			}

			.year-slider::-webkit-slider-thumb {
				-webkit-appearance: none;
				appearance: none;
				width: 20px;
				height: 20px;
				border-radius: 50%;
				background: #667eea;
				cursor: pointer;
				box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5);
			}

			.year-slider::-moz-range-thumb {
				width: 20px;
				height: 20px;
				border-radius: 50%;
				background: #667eea;
				cursor: pointer;
				border: none;
				box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5);
			}

			.year-display {
				font-size: 1.5rem;
				font-weight: 700;
				color: #667eea;
				min-width: 60px;
				text-align: center;
			}

			.play-btn {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				border: none;
				color: #fff;
				padding: 10px 20px;
				border-radius: 8px;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s;
				display: flex;
				align-items: center;
				gap: 8px;
			}

			.play-btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
			}

			.play-btn:active {
				transform: translateY(0);
			}

			.play-btn.playing {
				background: linear-gradient(135deg, #f06292 0%, #e91e63 100%);
			}

			.speed-btn {
				background: white;
				border: 2px solid #667eea;
				color: #667eea;
				padding: 10px 20px;
				border-radius: 8px;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s;
				display: flex;
				align-items: center;
				gap: 8px;
				font-size: 0.9rem;
			}

			.speed-btn:hover {
				background: #667eea;
				color: white;
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
			}

			.speed-btn:active {
				transform: translateY(0);
			}

			.speed-btn.fast {
				border-color: #10b981;
				color: #10b981;
			}

			.speed-btn.fast:hover {
				background: #10b981;
				color: white;
			}

			.speed-btn.slow {
				border-color: #f59e0b;
				color: #f59e0b;
			}

			.speed-btn.slow:hover {
				background: #f59e0b;
				color: white;
			}

			/* Lightning speed style (very fast) */
			.speed-btn.lightning {
				border-color: #ff3b30;
				color: #ff3b30;
			}

			.speed-btn.lightning:hover {
				background: #ff3b30;
				color: white;
			}

			.country {
				stroke: #999;
				stroke-width: 0.5px;
				cursor: pointer;
				transition: all 0.3s;
			}

			.country:hover {
				stroke: #667eea;
				stroke-width: 2px;
				filter: brightness(1.1);
			}

			.country.highlighted {
				stroke: #f59e0b;
				stroke-width: 2px;
			}

			.tooltip {
				position: absolute;
				background: rgba(0, 0, 0, 0.95);
				border: 2px solid #667eea;
				border-radius: 8px;
				padding: 12px;
				font-size: 13px;
				pointer-events: none;
				opacity: 0;
				transition: opacity 0.3s;
				z-index: 1000;
				max-width: 300px;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
			}

			.tooltip.show {
				opacity: 1;
			}

			.tooltip-title {
				font-weight: 700;
				font-size: 15px;
				margin-bottom: 6px;
				color: #667eea;
			}

			.tooltip-row {
				margin: 4px 0;
				display: flex;
				justify-content: space-between;
				gap: 15px;
			}

			.tooltip-label {
				color: #aaa;
			}

			.tooltip-value {
				font-weight: 600;
				color: #fff;
			}

			.legend {
				display: flex;
				align-items: center;
				gap: 15px;
				margin-top: 20px;
				padding: 15px;
				background: #f8f9fa;
				border-radius: 8px;
				flex-wrap: wrap;
			}

			.legend-title {
				font-weight: 600;
				color: #667eea;
				margin-right: 10px;
			}

			.legend-gradient {
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.gradient-bar {
				width: 200px;
				height: 20px;
				border-radius: 4px;
				border: 1px solid #e9ecef;
			}

			.gradient-labels {
				display: flex;
				justify-content: space-between;
				font-size: 11px;
				color: #666;
			}

			.map-container {
				position: relative;
				width: 100%;
			}

			.loading {
				text-align: center;
				padding: 40px;
				font-size: 1.1rem;
				color: #667eea;
			}

			.stats-box {
				background: #f8f9fa;
				border-left: 4px solid #667eea;
				border-radius: 8px;
				padding: 15px;
				margin-top: 20px;
			}

			.stats-row {
				display: flex;
				justify-content: space-between;
				margin: 8px 0;
				font-size: 0.95rem;
			}

			.stats-label {
				color: #666;
			}

			.stats-value {
				font-weight: 600;
				color: #667eea;
			}

			.view-toggle-btn {
				background: white;
				border: 2px solid #e9ecef;
				border: 2px solid rgba(102, 126, 234, 0.4);
				color: #fff;
				padding: 8px 20px;
				border-radius: 8px;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s;
				font-size: 0.9rem;
			}

			.view-toggle-btn:hover {
				background: rgba(102, 126, 234, 0.3);
				border-color: #667eea;
			}

			.view-toggle-btn.active {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				border-color: #667eea;
				box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
			}

			footer {
				margin-top: 40px;
				padding: 20px;
				border-top: 1px solid rgba(255, 255, 255, 0.1);
				text-align: center;
			}
		</style>
	</head>
	<body>
		<!-- Navigation Bar -->
		<nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
			<div class="container">
				<a class="navbar-brand fw-bold" href="index.html">
					<span style="color: #667eea">VABI</span> Project
				</a>
				<button
					class="navbar-toggler"
					type="button"
					data-bs-toggle="collapse"
					data-bs-target="#navbarNav"
				>
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav ms-auto">
						<li class="nav-item">
							<a class="nav-link active" href="index.html">Home</a>
						</li>
						<li class="nav-item dropdown">
							<a
								class="nav-link dropdown-toggle"
								href="#"
								id="dashboardDropdown"
								role="button"
								data-bs-toggle="dropdown"
							>
								Dashboards
							</a>
							<ul class="dropdown-menu">
								<!-- Human Trafficking Topic -->
								<li class="dropdown-submenu">
									<a class="dropdown-item has-submenu" href="#">Human Trafficking</a>
									<ul class="dropdown-menu">
										<li>
											<a class="dropdown-item" href="D1_chart1.html"
												>Types of Trafficking</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D1_chart5.html"
												>Flow of Trafficking</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D1_chart2.html"
												>Victims trafficked to other countries</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D1_chart3.html"
												>Trend of Victims being trafficked & Organ Removal</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D1_GDP_Analysis.html">GDP Analysis</a>
										</li>
									</ul>
								</li>

								<!-- Organ Demand and Supply Topic -->
								<li class="dropdown-submenu">
									<a class="dropdown-item has-submenu" href="#"
										>Organ Supply and Demand</a
									>
									<ul class="dropdown-menu">
										<li>
											<a class="dropdown-item" href="D2_chart1.html"
												>Organ Supply By Country</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D2_chart2.html"
												>Usable Organ Percentage</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D2_chart3.html"
												>Demand and Supply of Organs</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D2_chart4.html"
												>Transplant done vs Waiting list</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D2_chart5.html">Mortality Rate</a>
										</li>
									</ul>
								</li>

								<!-- Health Outcomes Topic -->
								<li class="dropdown-submenu">
									<a class="dropdown-item has-submenu" href="#">Health Outcomes</a>
									<ul class="dropdown-menu">
										<li>
											<a class="dropdown-item" href="D3_chart1.html"
												>Surgery Cost Comparison</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D3_chart2.html"
												>Hidden Costs After Surgery</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D3_chart3.html"
												>Health Outcomes Analysis</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D3_chart4.html"
												>Long Term Total Cost</a
											>
										</li>
									</ul>
								</li>

								<!-- Solution -->
								<li class="dropdown-submenu">
									<a class="dropdown-item has-submenu" href="#">Solution</a>
									<ul class="dropdown-menu">
										<li>
											<a class="dropdown-item" href="D4_chart1.html"
												>Pathways to More Organs</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D4_chart2.html"
												>US vs Iran: Spotlight Metrics</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D4_chart3.html"
												>What if we do nothing?</a
											>
										</li>
										<li>
											<a class="dropdown-item" href="D4_chart4.html"
												>Iran's Policy Reforms</a
											>
										</li>
									</ul>
								</li>
							</ul>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="#about">About</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="#contact">Contact</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<!-- Breadcrumb Navigation -->
		<div class="breadcrumb-nav">
			<div class="container-fluid">
				<nav aria-label="breadcrumb">
					<ol class="breadcrumb">
						<li class="breadcrumb-item"><a href="index.html">Home</a></li>
						<li class="breadcrumb-item">
							<a href="index.html#trafficking">Human Trafficking</a>
						</li>
						<li class="breadcrumb-item active" aria-current="page">GDP Analysis</li>
					</ol>
				</nav>
			</div>
		</div>
		<div class="container-fluid px-4">
			<!-- Hero Section -->
			<div class="hero-section">
				<h1>üåç GDP & GINI Temporal Analysis</h1>
				<p>
					Interactive Comparison: GDP (1960-2024) & GINI Coefficient (1963-2024) |
					Global vs Top 5 Economies
				</p>
			</div>

			<!-- Map 1: Global GDP -->
			<div class="card">
				<div class="card-header">
					üåê Map 1: Global GDP per Capita (Diverging from Global Average)
				</div>
				<div class="card-body">
					<div class="controls">
						<div class="year-control">
							<label>Year:</label>
							<input
								type="range"
								id="globalYearSlider"
								class="year-slider"
								min="1960"
								max="2024"
								value="2024"
								step="1"
							/>
							<span id="globalYearDisplay" class="year-display">2024</span>
						</div>
						<button id="globalPlayBtn" class="play-btn"><span>‚ñ∂</span> Play</button>
						<button id="globalSpeedBtn" class="speed-btn">
							<span>‚è±Ô∏è</span> Normal
						</button>
					</div>

					<div id="globalMap" class="map-container loading">
						Loading global map...
					</div>

					<div class="legend">
						<span class="legend-title">GDP per Capita:</span>
						<div class="legend-gradient">
							<div
								class="gradient-bar"
								style="background: linear-gradient(to right, #dc3545, #ffc107, #28a745)"
							></div>
						</div>
						<div style="width: 100%; margin-top: 5px">
							<div class="gradient-labels" style="width: 200px">
								<span>Below Average</span>
								<span>Average</span>
								<span>Above Average</span>
							</div>
						</div>
					</div>

					<div id="globalStats" class="stats-box">
						<div class="stats-row">
							<span class="stats-label">Global Average GDP:</span>
							<span id="globalAvgValue" class="stats-value">$0</span>
						</div>
						<div class="stats-row">
							<span class="stats-label">Countries with data:</span>
							<span id="globalCountCount" class="stats-value">0</span>
						</div>
						<div class="stats-row">
							<span class="stats-label">Highest GDP:</span>
							<span id="globalMaxValue" class="stats-value">-</span>
						</div>
						<div class="stats-row">
							<span class="stats-label">Lowest GDP:</span>
							<span id="globalMinValue" class="stats-value">-</span>
						</div>
					</div>
				</div>
			</div>

			<!-- Chart 2: Top 5 GDP Bar Chart -->
			<div class="card">
				<div class="card-header">
					üèÜ Chart 2: Top 5 Economies GDP Racing Bar Chart (1960-2024)
				</div>
				<div class="card-body">
					<div class="controls">
						<div class="year-control">
							<label>Year:</label>
							<input
								type="range"
								id="top5YearSlider"
								class="year-slider"
								min="1960"
								max="2024"
								value="2024"
								step="1"
							/>
							<span id="top5YearDisplay" class="year-display">2024</span>
						</div>
						<button id="top5PlayBtn" class="play-btn"><span>‚ñ∂</span> Play</button>
						<button id="top5SpeedBtn" class="speed-btn">
							<span>‚è±Ô∏è</span> Normal
						</button>
					</div>

					<div id="top5Chart" style="width: 100%; height: 500px"></div>
				</div>
			</div>

			<!-- Map 3: Global GINI -->
			<div class="card">
				<div class="card-header">
					üìä Map 3: Global GINI Coefficient (Diverging from Global Average)
				</div>
				<div class="card-body">
					<div class="controls">
						<div class="year-control">
							<label>Year:</label>
							<input
								type="range"
								id="giniGlobalYearSlider"
								class="year-slider"
								min="1963"
								max="2024"
								value="2018"
								step="1"
							/>
							<span id="giniGlobalYearDisplay" class="year-display">2018</span>
						</div>
						<button id="giniGlobalPlayBtn" class="play-btn">
							<span>‚ñ∂</span> Play
						</button>
						<button id="giniGlobalSpeedBtn" class="speed-btn">
							<span>‚è±Ô∏è</span> Normal
						</button>
					</div>

					<div id="giniGlobalMap" class="map-container loading">
						Loading global GINI map...
					</div>

					<div class="legend">
						<span class="legend-title">GINI Coefficient:</span>
						<div class="legend-gradient">
							<div
								class="gradient-bar"
								style="background: linear-gradient(to right, #28a745, #ffc107, #dc3545)"
							></div>
						</div>
						<div style="width: 100%; margin-top: 5px">
							<div class="gradient-labels" style="width: 200px">
								<span>Low Inequality</span>
								<span>Average</span>
								<span>High Inequality</span>
							</div>
						</div>
					</div>

					<div id="giniGlobalStats" class="stats-box">
						<div class="stats-row">
							<span class="stats-label">Global Average GINI:</span>
							<span id="giniGlobalAvgValue" class="stats-value">0</span>
						</div>
						<div class="stats-row">
							<span class="stats-label">Countries with data:</span>
							<span id="giniGlobalCountCount" class="stats-value">0</span>
						</div>
						<div class="stats-row">
							<span class="stats-label">Most Equal:</span>
							<span id="giniGlobalMinValue" class="stats-value">-</span>
						</div>
						<div class="stats-row">
							<span class="stats-label">Least Equal:</span>
							<span id="giniGlobalMaxValue" class="stats-value">-</span>
						</div>
					</div>
				</div>
			</div>

			<!-- Chart 4: Top 5 GINI Bar Chart -->
			<div class="card">
				<div class="card-header">
					üèÜ Chart 4: Top 5 Economies GINI Racing Bar Chart (1963-2024)
				</div>
				<div class="card-body">
					<div class="controls">
						<div class="year-control">
							<label>Year:</label>
							<input
								type="range"
								id="giniTop5YearSlider"
								class="year-slider"
								min="1963"
								max="2024"
								value="2020"
								step="1"
							/>
							<span id="giniTop5YearDisplay" class="year-display">2020</span>
						</div>
						<button id="giniTop5PlayBtn" class="play-btn"><span>‚ñ∂</span> Play</button>
						<button id="giniTop5SpeedBtn" class="speed-btn">
							<span>‚è±Ô∏è</span> Normal
						</button>
					</div>

					<div id="giniTop5Chart" style="width: 100%; height: 500px"></div>
				</div>
			</div>

			<!-- Chart 5: Pareto Chart - US Income Distribution by Decile -->
			<div class="card mt-4">
				<div class="card-header">
					üìä Chart 5: USA Income Distribution by Decile (Pareto Chart)
				</div>
				<div class="card-body">
					<div class="alert alert-info" role="alert">
						<strong>üí° Understanding the Pareto Principle:</strong> This chart shows
						how income is distributed across 10 equal population groups (deciles) in
						the United States. The bars represent each decile's share of total income,
						while the cumulative line shows the running total. The steeper the
						cumulative curve, the more unequal the distribution.
					</div>
					<div
						id="paretoChart"
						style="width: 100%; height: 750px; position: relative; padding: 20px 0"
					>
						<div
							id="paretoInfo"
							style="
								position: absolute;
								top: 30px;
								right: 30px;
								background: rgba(0, 0, 0, 0.9);
								padding: 18px;
								border-radius: 12px;
								font-size: 13px;
								color: #fff;
								border: 2px solid rgba(102, 126, 234, 0.5);
								box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
								max-width: 250px;
								z-index: 10;
							"
						>
							<div
								style="
									font-weight: 700;
									margin-bottom: 10px;
									color: #667eea;
									font-size: 15px;
								"
							>
								üìä Income Inequality Metrics
							</div>
							<div style="margin: 5px 0; font-size: 12px">
								<strong>Top 10%:</strong> <span id="top10Share">-</span>
							</div>
							<div style="margin: 5px 0; font-size: 12px">
								<strong>Bottom 50%:</strong> <span id="bottom50Share">-</span>
							</div>
							<div
								style="
									margin-top: 10px;
									font-size: 12px;
									color: #f59e0b;
									font-weight: 600;
									line-height: 1.4;
								"
							>
								<span id="inequalityLevel">-</span>
							</div>
							<div
								style="margin-top: 10px; font-size: 11px; color: #aaa; line-height: 1.5"
							>
								Based on 2023 US Census data
							</div>
						</div>
					</div>
				</div>
			</div>

			<footer class="text-muted small">
				Data source: World Bank GDP, GINI Coefficient & Poverty Headcount Ratio |
				Counter-Trafficking Data Collaborative (CTDC) | US Census Bureau Income
				Distribution | 217 countries | GDP: 1960-2024, GINI: 1963-2024, Headcount:
				1963-2024 |
				<strong>Chart 5 shows US income distribution by decile for 2023</strong>
			</footer>
		</div>
		<script>
			// ============================================
			// GLOBAL VARIABLES
			// ============================================

			let gdpData = [];
			let giniData = [];
			let headcountData = [];
			let scatterData = [];
			let worldGeoJSON = null;
			let globalPlayInterval = null;
			let top5PlayInterval = null;
			let giniGlobalPlayInterval = null;
			let giniTop5PlayInterval = null;
			let scatterPlayInterval = null;
			let currentScatterView = "bar"; // 'bar', 'scatter', 'log'

			// Animation speed control (in milliseconds) - separate for each chart
			let globalAnimationSpeed = 800; // Default: 800ms
			let top5AnimationSpeed = 800;
			let giniGlobalAnimationSpeed = 800;
			let giniTop5AnimationSpeed = 800;

			// Speed mode tracking for each chart
			let globalSpeedMode = "normal"; // 'fast', 'normal', 'slow', 'lightning'
			let top5SpeedMode = "normal";
			let giniGlobalSpeedMode = "normal";
			let giniTop5SpeedMode = "normal";

			const speedSettings = {
				fast: { speed: 300, icon: "‚ö°", label: "Fast", class: "fast" },
				normal: { speed: 800, icon: "‚è±Ô∏è", label: "Normal", class: "" },
				// New lightning speed (very fast)
				lightning: {
					speed: 100,
					icon: "‚ö°‚ö°",
					label: "Lightning",
					class: "lightning",
				},
				slow: { speed: 1500, icon: "üê¢", label: "Slow", class: "slow" },
			};

			const top5Countries = {
				USA: "United States",
				CHN: "China",
				DEU: "Germany",
				JPN: "Japan",
				IND: "India",
			}; // Custom formatter for GDP (use B for billions instead of G)
			function formatGDP(value) {
				if (value >= 1e12) {
					return "$" + (value / 1e12).toFixed(2) + "T"; // Trillions
				} else if (value >= 1e9) {
					return "$" + (value / 1e9).toFixed(2) + "B"; // Billions
				} else if (value >= 1e6) {
					return "$" + (value / 1e6).toFixed(2) + "M"; // Millions
				} else {
					return "$" + d3.format(",.0f")(value);
				}
			}

			// Create global tooltip
			const tooltip = d3.select("body").append("div").attr("class", "tooltip");

			// ============================================
			// DATA LOADING
			// ============================================

			Promise.all([
				d3.csv("gdp_cleaned.csv"),
				d3.csv("gini_cleaned.csv"),
				d3.csv("headcount_cleaned.csv"),
				d3.csv("headcount_trafficking_combined.csv"),
				d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"),
			])
				.then(([gdp, gini, headcount, scatter, world]) => {
					// Process scatter data (headcount vs trafficking)
					scatterData = scatter
						.filter(
							(d) =>
								d["Country Name"] &&
								d.Year &&
								d.Headcount !== undefined &&
								d.OrganCases &&
								+d.OrganCases > 0
						)
						.map((d) => ({
							country: d["Country Name"],
							code: d["Country Code"],
							year: +d.Year,
							headcount: +d.Headcount,
							organCases: +d.OrganCases,
						}));

					console.log("Scatter data loaded:", scatterData.length, "records");
					console.log(
						"Year range:",
						d3.min(scatterData, (d) => d.year),
						"-",
						d3.max(scatterData, (d) => d.year)
					);
					// Process GDP data (already cleaned to 217 actual countries)
					gdpData = gdp
						.filter((d) => d["Country Code"] && d.Year && d.GDP && +d.GDP > 0)
						.map((d) => ({
							code: d["Country Code"],
							country: d["Country Name"],
							year: +d.Year,
							gdp: +d.GDP,
						}));

					// Process GINI data
					giniData = gini
						.filter((d) => d["Country Code"] && d.Year && d.GINI && +d.GINI > 0)
						.map((d) => ({
							code: d["Country Code"],
							country: d["Country Name"],
							year: +d.Year,
							gini: +d.GINI,
						}));

					// Process Headcount data
					headcountData = headcount
						.filter(
							(d) => d["Country Code"] && d.Year && d.Headcount && +d.Headcount >= 0
						)
						.map((d) => ({
							code: d["Country Code"],
							country: d["Country Name"],
							year: +d.Year,
							headcount: +d.Headcount,
						}));

					// Process world GeoJSON
					worldGeoJSON = topojson.feature(world, world.objects.countries);

					// Initialize maps
					initGlobalMap();
					initTop5Map();
					initGiniGlobalMap();
					initGiniTop5Map();

					// Set up controls
					setupGlobalControls();
					setupTop5Controls();
					setupGiniGlobalControls();
					setupGiniTop5Controls();

					// Initialize Pareto chart
					initParetoChart();
				})
				.catch((error) => {
					console.error("Error loading data:", error);
					document.querySelectorAll(".loading").forEach((el) => {
						el.textContent = "Error loading data. Please check console for details.";
					});
				});

			// ============================================
			// MAP 1: GLOBAL GDP
			// ============================================

			function initGlobalMap() {
				const container = d3.select("#globalMap");
				container.html("");

				const containerWidth = container.node().getBoundingClientRect().width;
				const width = containerWidth;
				const height = 600;

				const svg = container
					.append("svg")
					.attr("width", width)
					.attr("height", height);

				const projection = d3
					.geoMercator()
					.scale(width / 6.5)
					.translate([width / 2, height / 1.5]);

				const path = d3.geoPath().projection(projection);

				const g = svg.append("g");

				// Draw countries
				g.selectAll("path")
					.data(worldGeoJSON.features)
					.enter()
					.append("path")
					.attr("class", "country")
					.attr("d", path)
					.attr("id", (d) => "global-" + d.id)
					.on("mouseover", handleGlobalMouseover)
					.on("mouseout", () => tooltip.classed("show", false));

				// Initial render
				updateGlobalMap(2024);
			}

			function updateGlobalMap(year) {
				// Filter data for selected year
				const yearData = gdpData.filter((d) => d.year === year);

				if (yearData.length === 0) {
					console.warn("No data for year:", year);
					return;
				}

				// Calculate global average
				const globalAverage = d3.mean(yearData, (d) => d.gdp);

				// Create lookup map
				const gdpMap = new Map(yearData.map((d) => [d.code, d.gdp]));

				// Create diverging color scale
				const maxGdp = d3.max(yearData, (d) => d.gdp);
				const minGdp = d3.min(yearData, (d) => d.gdp);

				const colorScale = d3
					.scaleLinear()
					.domain([minGdp, globalAverage, maxGdp])
					.range(["#dc3545", "#ffc107", "#28a745"])
					.interpolate(d3.interpolateRgb);

				// Calculate transition duration based on animation speed (70% of interval)
				const transitionDuration = Math.max(globalAnimationSpeed * 0.7, 50);

				// Update country colors
				worldGeoJSON.features.forEach((feature) => {
					const code = getCountryCode(feature);
					const gdp = gdpMap.get(code);
					const color = gdp ? colorScale(gdp) : "#333";

					d3
						.select("#global-" + feature.id)
						.transition()
						.duration(transitionDuration)
						.attr("fill", color);
				});

				// Update stats
				const maxCountry = yearData.reduce((max, d) => (d.gdp > max.gdp ? d : max));
				const minCountry = yearData.reduce((min, d) => (d.gdp < min.gdp ? d : min));

				d3.select("#globalAvgValue").text("$" + d3.format(",.0f")(globalAverage));
				d3.select("#globalCountCount").text(yearData.length);
				d3
					.select("#globalMaxValue")
					.text(`${maxCountry.country} ($${d3.format(",.0f")(maxCountry.gdp)})`);
				d3
					.select("#globalMinValue")
					.text(`${minCountry.country} ($${d3.format(",.0f")(minCountry.gdp)})`);
			}

			function handleGlobalMouseover(event, d) {
				const code = getCountryCode(d);
				const year = +document.getElementById("globalYearSlider").value;
				const yearData = gdpData.filter((data) => data.year === year);
				const countryData = yearData.find((data) => data.code === code);
				const globalAverage = d3.mean(yearData, (data) => data.gdp);

				if (countryData) {
					const diff = countryData.gdp - globalAverage;
					const diffPercent = ((diff / globalAverage) * 100).toFixed(1);
					const indicator = diff > 0 ? "‚ñ≤" : "‚ñº";
					const color = diff > 0 ? "#28a745" : "#dc3545";

					tooltip
						.classed("show", true)
						.html(
							`
					         <div class="tooltip-title">${countryData.country}</div>
					         <div class="tooltip-row">
					           <span class="tooltip-label">Year:</span>
					           <span class="tooltip-value">${year}</span>
					         </div>
					         <div class="tooltip-row">
					           <span class="tooltip-label">GDP per capita:</span>
					           <span class="tooltip-value">$${d3.format(",.0f")(
																	countryData.gdp
																)}</span>
					         </div>
					         <div class="tooltip-row">
					           <span class="tooltip-label">Global average:</span>
					           <span class="tooltip-value">$${d3.format(",.0f")(
																	globalAverage
																)}</span>
					         </div>
					         <div class="tooltip-row">
					           <span class="tooltip-label">Difference:</span>
					           <span class="tooltip-value" style="color: ${color};">${indicator} ${Math.abs(
								diffPercent
							)}%</span>
					         </div>
					       `
						)
						.style("left", event.pageX + 15 + "px")
						.style("top", event.pageY - 28 + "px");
				}
			}

			// ============================================
			// MAP 2: TOP 5 COUNTRIES
			// ============================================

			// ============================================
			// CHART 2: TOP 5 GDP BAR CHART
			// ============================================

			function initTop5Map() {
				const container = d3.select("#top5Chart");
				container.html("");

				const containerWidth = container.node().getBoundingClientRect().width;
				const width = containerWidth;
				const height = 500;
				const margin = { top: 20, right: 150, bottom: 40, left: 200 };

				const svg = container
					.append("svg")
					.attr("width", width)
					.attr("height", height);

				const g = svg
					.append("g")
					.attr("transform", `translate(${margin.left},${margin.top})`);

				// Add axes groups
				g.append("g").attr("class", "x-axis");
				g.append("g").attr("class", "y-axis");

				// Initial render
				updateTop5Map(2024);
			}

			function updateTop5Map(year) {
				const container = d3.select("#top5Chart");
				const containerWidth = container.node().getBoundingClientRect().width;
				const width = containerWidth;
				const height = 500;
				const margin = { top: 20, right: 150, bottom: 40, left: 200 };
				const chartWidth = width - margin.left - margin.right;
				const chartHeight = height - margin.top - margin.bottom;

				// Filter data for selected year and top 5 countries
				const top5Codes = Object.keys(top5Countries);
				const yearData = gdpData.filter(
					(d) => d.year === year && top5Codes.includes(d.code)
				);

				if (yearData.length === 0) {
					console.warn("No GDP data for year:", year);
					return;
				}

				// Sort by GDP descending
				yearData.sort((a, b) => b.gdp - a.gdp);

				const svg = container.select("svg");
				const g = svg.select("g");

				// Scales
				const xScale = d3
					.scaleLinear()
					.domain([0, d3.max(yearData, (d) => d.gdp)])
					.range([0, chartWidth]);

				const yScale = d3
					.scaleBand()
					.domain(yearData.map((d) => d.country))
					.range([0, chartHeight])
					.padding(0.2);

				// Color scale
				const colorScale = d3
					.scaleOrdinal()
					.domain(top5Codes)
					.range(["#3b82f6", "#ef4444", "#f59e0b", "#8b5cf6", "#10b981"]);

				// Calculate transition duration based on animation speed (70% of interval)
				const transitionDuration = Math.max(top5AnimationSpeed * 0.7, 50);

				// Update bars
				const bars = g.selectAll(".bar").data(yearData, (d) => d.code);

				// Exit
				bars
					.exit()
					.transition()
					.duration(transitionDuration * 0.6)
					.attr("width", 0)
					.remove();

				// Enter + Update
				bars
					.enter()
					.append("rect")
					.attr("class", "bar")
					.attr("x", 0)
					.attr("y", (d) => yScale(d.country))
					.attr("width", 0)
					.attr("height", yScale.bandwidth())
					.attr("fill", (d) => colorScale(d.code))
					.attr("rx", 4)
					.merge(bars)
					.transition()
					.duration(transitionDuration)
					.attr("y", (d) => yScale(d.country))
					.attr("width", (d) => xScale(d.gdp))
					.attr("height", yScale.bandwidth());

				// Update labels
				const labels = g.selectAll(".bar-label").data(yearData, (d) => d.code);

				labels.exit().remove();

				labels
					.enter()
					.append("text")
					.attr("class", "bar-label")
					.attr("x", (d) => {
						const barEnd = xScale(d.gdp);
						const labelWidth = 80; // Approximate width
						// If label would overflow, place inside bar
						return barEnd + labelWidth + 20 > chartWidth
							? barEnd - 5 // Inside bar
							: barEnd + 10; // Outside bar
					})
					.attr("y", (d) => yScale(d.country) + yScale.bandwidth() / 2)
					.attr("dy", "0.35em")
					.attr("text-anchor", (d) => {
						const barEnd = xScale(d.gdp);
						const labelWidth = 80;
						return barEnd + labelWidth + 20 > chartWidth ? "end" : "start";
					})
					.style("font-size", "14px")
					.style("font-weight", "600")
					.style("fill", (d) => {
						const barEnd = xScale(d.gdp);
						const labelWidth = 80;
						// White text inside bars, colored outside
						return barEnd + labelWidth + 20 > chartWidth ? "#ffffff" : "#667eea";
					})
					.merge(labels)
					.transition()
					.duration(transitionDuration)
					.attr("x", (d) => {
						const barEnd = xScale(d.gdp);
						const labelWidth = 80;
						return barEnd + labelWidth + 20 > chartWidth ? barEnd - 5 : barEnd + 10;
					})
					.attr("y", (d) => yScale(d.country) + yScale.bandwidth() / 2)
					.attr("text-anchor", (d) => {
						const barEnd = xScale(d.gdp);
						const labelWidth = 80;
						return barEnd + labelWidth + 20 > chartWidth ? "end" : "start";
					})
					.style("fill", (d) => {
						const barEnd = xScale(d.gdp);
						const labelWidth = 80;
						return barEnd + labelWidth + 20 > chartWidth ? "#ffffff" : "#667eea";
					})
					.text((d) => formatGDP(d.gdp)); // Update axes
				const xAxis = d3
					.axisBottom(xScale)
					.ticks(5)
					.tickFormat((d) => formatGDP(d));

				const yAxis = d3.axisLeft(yScale);

				g.select(".x-axis")
					.attr("transform", `translate(0,${chartHeight})`)
					.transition()
					.duration(transitionDuration)
					.call(xAxis)
					.selectAll("text")
					.style("fill", "#ccc");

				g.select(".y-axis")
					.transition()
					.duration(transitionDuration)
					.call(yAxis)
					.selectAll("text")
					.style("font-size", "14px")
					.style("font-weight", "600")
					.style("fill", "#333");

				// Style axes
				g.selectAll(".x-axis path, .x-axis line, .y-axis path, .y-axis line").style(
					"stroke",
					"#666"
				);
			}

			// ============================================
			// CONTROLS
			// ============================================

			// Speed control functions for each chart
			function cycleSpeed(chartType) {
				// Cycle order: normal -> fast -> lightning -> slow
				const speedOrder = ["normal", "fast", "lightning", "slow"];
				let currentMode, speedVar, buttonId, playInterval, playBtnId;

				// Determine which chart to control
				switch (chartType) {
					case "global":
						currentMode = globalSpeedMode;
						buttonId = "globalSpeedBtn";
						playInterval = globalPlayInterval;
						playBtnId = "globalPlayBtn";
						break;
					case "top5":
						currentMode = top5SpeedMode;
						buttonId = "top5SpeedBtn";
						playInterval = top5PlayInterval;
						playBtnId = "top5PlayBtn";
						break;
					case "giniGlobal":
						currentMode = giniGlobalSpeedMode;
						buttonId = "giniGlobalSpeedBtn";
						playInterval = giniGlobalPlayInterval;
						playBtnId = "giniGlobalPlayBtn";
						break;
					case "giniTop5":
						currentMode = giniTop5SpeedMode;
						buttonId = "giniTop5SpeedBtn";
						playInterval = giniTop5PlayInterval;
						playBtnId = "giniTop5PlayBtn";
						break;
					default:
						return;
				}

				// Cycle to next speed
				const currentIndex = speedOrder.indexOf(currentMode);
				const nextIndex = (currentIndex + 1) % speedOrder.length;
				const nextMode = speedOrder[nextIndex];
				const nextSettings = speedSettings[nextMode];

				// Update speed variable
				switch (chartType) {
					case "global":
						globalSpeedMode = nextMode;
						globalAnimationSpeed = nextSettings.speed;
						break;
					case "top5":
						top5SpeedMode = nextMode;
						top5AnimationSpeed = nextSettings.speed;
						break;
					case "giniGlobal":
						giniGlobalSpeedMode = nextMode;
						giniGlobalAnimationSpeed = nextSettings.speed;
						break;
					case "giniTop5":
						giniTop5SpeedMode = nextMode;
						giniTop5AnimationSpeed = nextSettings.speed;
						break;
				}

				// Update button
				const btn = document.getElementById(buttonId);
				btn.innerHTML = `<span>${nextSettings.icon}</span> ${nextSettings.label}`;
				btn.className = `speed-btn ${nextSettings.class}`;

				// If animation is playing, restart it with new speed
				if (playInterval) {
					const playBtn = document.getElementById(playBtnId);
					playBtn.click(); // Stop
					setTimeout(() => playBtn.click(), 100); // Restart
				}
			}

			function setupGlobalControls() {
				const slider = document.getElementById("globalYearSlider");
				const display = document.getElementById("globalYearDisplay");
				const playBtn = document.getElementById("globalPlayBtn");
				const speedBtn = document.getElementById("globalSpeedBtn");

				slider.addEventListener("input", (e) => {
					const year = +e.target.value;
					display.textContent = year;
					updateGlobalMap(year);
				});

				speedBtn.addEventListener("click", () => {
					cycleSpeed("global");
				});

				playBtn.addEventListener("click", () => {
					if (globalPlayInterval) {
						// Stop playing
						clearInterval(globalPlayInterval);
						globalPlayInterval = null;
						playBtn.innerHTML = "<span>‚ñ∂</span> Play";
						playBtn.classList.remove("playing");
					} else {
						// Start playing
						playBtn.innerHTML = "<span>‚è∏</span> Pause";
						playBtn.classList.add("playing");

						globalPlayInterval = setInterval(() => {
							let currentYear = +slider.value;
							currentYear++;

							if (currentYear > 2024) {
								currentYear = 1960;
							}

							slider.value = currentYear;
							display.textContent = currentYear;
							updateGlobalMap(currentYear);
						}, globalAnimationSpeed); // Use global animation speed
					}
				});
			}
			function setupTop5Controls() {
				const slider = document.getElementById("top5YearSlider");
				const display = document.getElementById("top5YearDisplay");
				const playBtn = document.getElementById("top5PlayBtn");
				const speedBtn = document.getElementById("top5SpeedBtn");

				slider.addEventListener("input", (e) => {
					const year = +e.target.value;
					display.textContent = year;
					updateTop5Map(year);
				});

				speedBtn.addEventListener("click", () => {
					cycleSpeed("top5");
				});

				playBtn.addEventListener("click", () => {
					if (top5PlayInterval) {
						// Stop playing
						clearInterval(top5PlayInterval);
						top5PlayInterval = null;
						playBtn.innerHTML = "<span>‚ñ∂</span> Play";
						playBtn.classList.remove("playing");
					} else {
						// Start playing
						playBtn.innerHTML = "<span>‚è∏</span> Pause";
						playBtn.classList.add("playing");

						top5PlayInterval = setInterval(() => {
							let currentYear = +slider.value;
							currentYear++;

							if (currentYear > 2024) {
								currentYear = 1960;
							}

							slider.value = currentYear;
							display.textContent = currentYear;
							updateTop5Map(currentYear);
						}, top5AnimationSpeed); // Use top5 animation speed
					}
				});
			}

			// ============================================
			// MAP 3: GLOBAL GINI
			// ============================================

			function initGiniGlobalMap() {
				const container = d3.select("#giniGlobalMap");
				container.html("");

				const containerWidth = container.node().getBoundingClientRect().width;
				const width = containerWidth;
				const height = 600;

				const svg = container
					.append("svg")
					.attr("width", width)
					.attr("height", height);

				const projection = d3
					.geoMercator()
					.scale(width / 6.5)
					.translate([width / 2, height / 1.5]);

				const path = d3.geoPath().projection(projection);

				const g = svg.append("g");

				// Draw countries
				g.selectAll("path")
					.data(worldGeoJSON.features)
					.enter()
					.append("path")
					.attr("class", "country")
					.attr("d", path)
					.attr("id", (d) => "gini-global-" + d.id)
					.on("mouseover", handleGiniGlobalMouseover)
					.on("mouseout", () => tooltip.classed("show", false));

				// Initial render with most recent year that has data
				const latestYear = d3.max(giniData, (d) => d.year);
				console.log("GINI data loaded:", giniData.length, "records");
				console.log("Latest GINI year:", latestYear);

				// Find a year with good data coverage (prefer recent years)
				// Data shows 2018 had best coverage (93 countries)
				let bestYear = 2018;
				const dataCount = giniData.filter((d) => d.year === bestYear).length;
				console.log(`Using year ${bestYear} with ${dataCount} countries`);

				updateGiniGlobalMap(bestYear);
				document.getElementById("giniGlobalYearSlider").value = bestYear;
				document.getElementById("giniGlobalYearDisplay").textContent = bestYear;
			}

			function updateGiniGlobalMap(year) {
				// Filter data for selected year
				const yearData = giniData.filter((d) => d.year === year);

				if (yearData.length === 0) {
					console.warn("No GINI data for year:", year);
					d3.select("#giniGlobalAvgValue").text("N/A");
					d3.select("#giniGlobalCountCount").text("0");
					d3.select("#giniGlobalMaxValue").text("-");
					d3.select("#giniGlobalMinValue").text("-");
					return;
				}

				// Calculate global average
				const globalAverage = d3.mean(yearData, (d) => d.gini);

				// Create lookup map
				const giniMap = new Map(yearData.map((d) => [d.code, d.gini]));

				// Create diverging color scale (reversed: low GINI = green/equal, high GINI = red/unequal)
				const maxGini = d3.max(yearData, (d) => d.gini);
				const minGini = d3.min(yearData, (d) => d.gini);

				const colorScale = d3
					.scaleLinear()
					.domain([minGini, globalAverage, maxGini])
					.range(["#28a745", "#ffc107", "#dc3545"])
					.interpolate(d3.interpolateRgb);

				// Calculate transition duration based on animation speed (70% of interval)
				const transitionDuration = Math.max(giniGlobalAnimationSpeed * 0.7, 50);

				// Update country colors
				worldGeoJSON.features.forEach((feature) => {
					const code = getCountryCode(feature);
					const gini = giniMap.get(code);
					const color = gini ? colorScale(gini) : "#333";

					d3
						.select("#gini-global-" + feature.id)
						.transition()
						.duration(transitionDuration)
						.attr("fill", color);
				});

				// Update stats
				const maxCountry = yearData.reduce((max, d) =>
					d.gini > max.gini ? d : max
				);
				const minCountry = yearData.reduce((min, d) =>
					d.gini < min.gini ? d : min
				);

				d3.select("#giniGlobalAvgValue").text(globalAverage.toFixed(1));
				d3.select("#giniGlobalCountCount").text(yearData.length);
				d3
					.select("#giniGlobalMaxValue")
					.text(`${maxCountry.country} (${maxCountry.gini.toFixed(1)})`);
				d3
					.select("#giniGlobalMinValue")
					.text(`${minCountry.country} (${minCountry.gini.toFixed(1)})`);
			}

			function handleGiniGlobalMouseover(event, d) {
				const code = getCountryCode(d);
				const year = +document.getElementById("giniGlobalYearSlider").value;
				const yearData = giniData.filter((data) => data.year === year);
				const countryData = yearData.find((data) => data.code === code);
				const globalAverage = d3.mean(yearData, (data) => data.gini);

				if (countryData) {
					const diff = countryData.gini - globalAverage;
					const diffPercent = ((diff / globalAverage) * 100).toFixed(1);
					const indicator = diff > 0 ? "‚ñ≤" : "‚ñº";
					const color = diff > 0 ? "#dc3545" : "#28a745"; // Higher GINI = more inequality = red

					tooltip
						.classed("show", true)
						.html(
							`
					         <div class="tooltip-title">${countryData.country}</div>
					         <div class="tooltip-row">
					           <span class="tooltip-label">Year:</span>
					           <span class="tooltip-value">${year}</span>
					         </div>
					         <div class="tooltip-row">
					           <span class="tooltip-label">GINI Coefficient:</span>
					           <span class="tooltip-value">${countryData.gini.toFixed(1)}</span>
					         </div>
					         <div class="tooltip-row">
					           <span class="tooltip-label">Global average:</span>
					           <span class="tooltip-value">${globalAverage.toFixed(1)}</span>
					         </div>
					         <div class="tooltip-row">
					           <span class="tooltip-label">Difference:</span>
					           <span class="tooltip-value" style="color: ${color};">${indicator} ${Math.abs(
								diffPercent
							)}% ${diff > 0 ? "more unequal" : "more equal"}</span>
					         </div>
					       `
						)
						.style("left", event.pageX + 15 + "px")
						.style("top", event.pageY - 28 + "px");
				}
			}

			// ============================================
			// MAP 4: TOP 5 GINI
			// ============================================

			// ============================================
			// CHART 4: TOP 5 GINI BAR CHART
			// ============================================

			// Helper function to check if year has at least 3 countries with data
			function hasEnoughGiniData(year) {
				const top5Codes = Object.keys(top5Countries);
				const count = giniData.filter(
					(d) => d.year === year && top5Codes.includes(d.code)
				).length;
				return count >= 3;
			}

			function initGiniTop5Map() {
				const container = d3.select("#giniTop5Chart");
				container.html("");

				const containerWidth = container.node().getBoundingClientRect().width;
				const width = containerWidth;
				const height = 500;
				const margin = { top: 20, right: 150, bottom: 40, left: 200 };

				const svg = container
					.append("svg")
					.attr("width", width)
					.attr("height", height);

				const g = svg
					.append("g")
					.attr("transform", `translate(${margin.left},${margin.top})`);

				// Add axes groups
				g.append("g").attr("class", "x-axis");
				g.append("g").attr("class", "y-axis");

				// Initial render with most recent year that has data for top 5
				const top5Codes = Object.keys(top5Countries);
				const latestYear = d3.max(
					giniData.filter((d) => top5Codes.includes(d.code)),
					(d) => d.year
				);
				console.log("Latest GINI year for Top 5:", latestYear);

				// Use 2020 - last year with 4/5 countries (CHN, DEU, JPN, USA)
				let bestYear = 2020;
				const dataCount = giniData.filter(
					(d) => d.year === bestYear && top5Codes.includes(d.code)
				).length;
				console.log(`Using year ${bestYear} with ${dataCount}/5 top countries`);

				updateGiniTop5Map(bestYear);
				document.getElementById("giniTop5YearSlider").value = bestYear;
				document.getElementById("giniTop5YearDisplay").textContent = bestYear;
			}

			function updateGiniTop5Map(year) {
				const container = d3.select("#giniTop5Chart");
				const containerWidth = container.node().getBoundingClientRect().width;
				const width = containerWidth;
				const height = 500;
				const margin = { top: 20, right: 150, bottom: 40, left: 200 };
				const chartWidth = width - margin.left - margin.right;
				const chartHeight = height - margin.top - margin.bottom;

				// Filter data for selected year and top 5 countries
				const top5Codes = Object.keys(top5Countries);
				let yearData = giniData.filter(
					(d) => d.year === year && top5Codes.includes(d.code)
				);

				if (yearData.length === 0) {
					console.warn("No GINI data for top 5 in year:", year);
					return;
				}

				// Sort by GINI ascending (lower GINI = more equal = better rank)
				yearData.sort((a, b) => a.gini - b.gini);

				const svg = container.select("svg");
				const g = svg.select("g");

				// Scales
				const xScale = d3
					.scaleLinear()
					.domain([0, d3.max(yearData, (d) => d.gini) * 1.1])
					.range([0, chartWidth]);

				const yScale = d3
					.scaleBand()
					.domain(yearData.map((d) => d.country))
					.range([0, chartHeight])
					.padding(0.2);

				// Color scale (green = low GINI/equal, red = high GINI/unequal)
				const colorScale = d3
					.scaleOrdinal()
					.domain(top5Codes)
					.range(["#3b82f6", "#ef4444", "#f59e0b", "#8b5cf6", "#10b981"]);

				// Calculate transition duration based on animation speed (70% of interval)
				const transitionDuration = Math.max(giniTop5AnimationSpeed * 0.7, 50);

				// Update bars
				const bars = g.selectAll(".bar").data(yearData, (d) => d.code);

				// Exit
				bars
					.exit()
					.transition()
					.duration(transitionDuration * 0.6)
					.attr("width", 0)
					.remove();

				// Enter + Update
				bars
					.enter()
					.append("rect")
					.attr("class", "bar")
					.attr("x", 0)
					.attr("y", (d) => yScale(d.country))
					.attr("width", 0)
					.attr("height", yScale.bandwidth())
					.attr("fill", (d) => colorScale(d.code))
					.attr("rx", 4)
					.merge(bars)
					.transition()
					.duration(transitionDuration)
					.attr("y", (d) => yScale(d.country))
					.attr("width", (d) => xScale(d.gini))
					.attr("height", yScale.bandwidth());

				// Update labels
				const labels = g.selectAll(".bar-label").data(yearData, (d) => d.code);

				labels.exit().remove();

				labels
					.enter()
					.append("text")
					.attr("class", "bar-label")
					.attr("x", (d) => {
						const barEnd = xScale(d.gini);
						const labelWidth = 60; // Smaller for GINI (e.g., "34.5")
						// If label would overflow, place inside bar
						return barEnd + labelWidth + 20 > chartWidth
							? barEnd - 5 // Inside bar
							: barEnd + 10; // Outside bar
					})
					.attr("y", (d) => yScale(d.country) + yScale.bandwidth() / 2)
					.attr("dy", "0.35em")
					.attr("text-anchor", (d) => {
						const barEnd = xScale(d.gini);
						const labelWidth = 60;
						return barEnd + labelWidth + 20 > chartWidth ? "end" : "start";
					})
					.style("font-size", "14px")
					.style("font-weight", "600")
					.style("fill", (d) => {
						const barEnd = xScale(d.gini);
						const labelWidth = 60;
						// White text inside bars, colored outside
						return barEnd + labelWidth + 20 > chartWidth ? "#ffffff" : "#667eea";
					})
					.merge(labels)
					.transition()
					.duration(transitionDuration)
					.attr("x", (d) => {
						const barEnd = xScale(d.gini);
						const labelWidth = 60;
						return barEnd + labelWidth + 20 > chartWidth ? barEnd - 5 : barEnd + 10;
					})
					.attr("y", (d) => yScale(d.country) + yScale.bandwidth() / 2)
					.attr("text-anchor", (d) => {
						const barEnd = xScale(d.gini);
						const labelWidth = 60;
						return barEnd + labelWidth + 20 > chartWidth ? "end" : "start";
					})
					.style("fill", (d) => {
						const barEnd = xScale(d.gini);
						const labelWidth = 60;
						return barEnd + labelWidth + 20 > chartWidth ? "#ffffff" : "#667eea";
					})
					.text((d) => d.gini.toFixed(1)); // Update axes
				const xAxis = d3.axisBottom(xScale).ticks(5);

				const yAxis = d3.axisLeft(yScale);

				g.select(".x-axis")
					.attr("transform", `translate(0,${chartHeight})`)
					.transition()
					.duration(transitionDuration)
					.call(xAxis)
					.selectAll("text")
					.style("fill", "#ccc");

				g.select(".y-axis")
					.transition()
					.duration(transitionDuration)
					.call(yAxis)
					.selectAll("text")
					.style("font-size", "14px")
					.style("font-weight", "600")
					.style("fill", "#333");

				// Style axes
				g.selectAll(".x-axis path, .x-axis line, .y-axis path, .y-axis line").style(
					"stroke",
					"#666"
				);
			}

			// ============================================
			// GINI CONTROLS
			// ============================================

			function setupGiniGlobalControls() {
				const slider = document.getElementById("giniGlobalYearSlider");
				const display = document.getElementById("giniGlobalYearDisplay");
				const playBtn = document.getElementById("giniGlobalPlayBtn");
				const speedBtn = document.getElementById("giniGlobalSpeedBtn");

				slider.addEventListener("input", (e) => {
					const year = +e.target.value;
					display.textContent = year;
					updateGiniGlobalMap(year);
				});

				speedBtn.addEventListener("click", () => {
					cycleSpeed("giniGlobal");
				});

				playBtn.addEventListener("click", () => {
					if (giniGlobalPlayInterval) {
						// Stop playing
						clearInterval(giniGlobalPlayInterval);
						giniGlobalPlayInterval = null;
						playBtn.innerHTML = "<span>‚ñ∂</span> Play";
						playBtn.classList.remove("playing");
					} else {
						// Start playing
						playBtn.innerHTML = "<span>‚è∏</span> Pause";
						playBtn.classList.add("playing");

						giniGlobalPlayInterval = setInterval(() => {
							let currentYear = +slider.value;
							currentYear++;

							if (currentYear > 2024) {
								currentYear = 1963;
							}

							slider.value = currentYear;
							display.textContent = currentYear;
							updateGiniGlobalMap(currentYear);
						}, giniGlobalAnimationSpeed); // Use giniGlobal animation speed
					}
				});
			}

			function setupGiniTop5Controls() {
				const slider = document.getElementById("giniTop5YearSlider");
				const display = document.getElementById("giniTop5YearDisplay");
				const playBtn = document.getElementById("giniTop5PlayBtn");
				const speedBtn = document.getElementById("giniTop5SpeedBtn");

				slider.addEventListener("input", (e) => {
					const year = +e.target.value;
					display.textContent = year;
					updateGiniTop5Map(year);
				});

				speedBtn.addEventListener("click", () => {
					cycleSpeed("giniTop5");
				});

				playBtn.addEventListener("click", () => {
					if (giniTop5PlayInterval) {
						// Stop playing
						clearInterval(giniTop5PlayInterval);
						giniTop5PlayInterval = null;
						playBtn.innerHTML = "<span>‚ñ∂</span> Play";
						playBtn.classList.remove("playing");
					} else {
						// Start playing
						playBtn.innerHTML = "<span>‚è∏</span> Pause";
						playBtn.classList.add("playing");

						giniTop5PlayInterval = setInterval(() => {
							let currentYear = +slider.value;

							// Find next year with at least 3 countries
							let attempts = 0;
							do {
								currentYear++;
								if (currentYear > 2024) {
									currentYear = 1963;
								}
								attempts++;
								// Prevent infinite loop
								if (attempts > 100) {
									clearInterval(giniTop5PlayInterval);
									giniTop5PlayInterval = null;
									playBtn.innerHTML = "<span>‚ñ∂</span> Play";
									playBtn.classList.remove("playing");
									console.error("No valid years found with 3+ countries");
									return;
								}
							} while (!hasEnoughGiniData(currentYear));

							slider.value = currentYear;
							display.textContent = currentYear;
							updateGiniTop5Map(currentYear);
						}, giniTop5AnimationSpeed); // Use giniTop5 animation speed
					}
				});
			}

			// ============================================
			// CHART 8: PARETO CHART - US INCOME DISTRIBUTION BY DECILE
			// Multi-Stage Animated Pareto Chart
			// ============================================

			let paretoStage = 0;
			let paretoData = [];
			let paretoSvg, paretoG, paretoWidth, paretoHeight, paretoMargin;
			let paretoXScale, paretoYScaleLeft, paretoYScaleRight;

		function initParetoChart() {
			// US Income Distribution data from World Bank - Poverty & Inequality Platform
			// Data source: Decile/povertyinequality.csv (United States, reporting_year=2023)
			// Source: CPS-ASEC-LIS (Current Population Survey, income-based)
			// Converted from decimal format to percentage
			const incomeData = [
				{ decile: "Top 10%", share: 30.433, order: 1 },      // decile10: 0.30432758214
				{ decile: "90-80%", share: 16.382, order: 2 },       // decile9: 0.163821646934
				{ decile: "80-70%", share: 12.527, order: 3 },       // decile8: 0.125267321952
				{ decile: "70-60%", share: 10.164, order: 4 },       // decile7: 0.101643182452
				{ decile: "60-50%", share: 8.340, order: 5 },        // decile6: 0.083402396464
				{ decile: "50-40%", share: 6.867, order: 6 },        // decile5: 0.068667663116
				{ decile: "40-30%", share: 5.641, order: 7 },        // decile4: 0.056409294851
				{ decile: "30-20%", share: 4.504, order: 8 },        // decile3: 0.045035586189
				{ decile: "20-10%", share: 3.376, order: 9 },        // decile2: 0.033761485481
				{ decile: "Bottom 10%", share: 1.766, order: 10 }    // decile1: 0.017663840421
			];				// Calculate cumulative percentages
				let cumulative = 0;
				incomeData.forEach((d) => {
					cumulative += d.share;
					d.cumulative = cumulative;
				});

				paretoData = incomeData;

				// Update info panel
				const top10 = paretoData[0].share;
				const bottom50 = paretoData.slice(5).reduce((sum, d) => sum + d.share, 0);
				document.getElementById("top10Share").textContent = `${top10.toFixed(
					1
				)}% of total income`;
				document.getElementById("bottom50Share").textContent = `${bottom50.toFixed(
					1
				)}% of total income`;
				const ratio = (top10 / bottom50).toFixed(1);
				document.getElementById(
					"inequalityLevel"
				).textContent = `Top 10% earns ${ratio}√ó more than bottom 50% combined`;

				const container = d3.select("#paretoChart");
				container.html("");

				const containerWidth = container.node().getBoundingClientRect().width;
				paretoMargin = { top: 90, right: 120, bottom: 120, left: 90 };
				paretoWidth = containerWidth - paretoMargin.left - paretoMargin.right;
				paretoHeight = 650 - paretoMargin.top - paretoMargin.bottom;

				paretoSvg = container
					.append("svg")
					.attr("width", containerWidth)
					.attr("height", 650);

				paretoG = paretoSvg
					.append("g")
					.attr("transform", `translate(${paretoMargin.left},${paretoMargin.top})`);

				// Add control buttons
				const buttonContainer = container
					.insert("div", "svg")
					.style("text-align", "center")
					.style("margin-bottom", "20px")
					.style("display", "flex")
					.style("align-items", "center")
					.style("justify-content", "center")
					.style("gap", "15px")
					.style("flex-wrap", "wrap");

				buttonContainer
					.append("button")
					.attr("id", "paretoViewBtn")
					.attr("class", "play-btn")
					.style("margin", "0")
					.style("padding", "12px 30px")
					.style("font-size", "16px")
					.style("font-weight", "700")
					.html("üìä Show Pareto Chart")
					.on("click", animateToParetoView);

				buttonContainer
					.append("button")
					.attr("id", "stackedViewBtn")
					.attr("class", "play-btn")
					.style("margin", "0")
					.style("padding", "12px 30px")
					.style("font-size", "16px")
					.style("font-weight", "700")
					.html("üìö Show Stacked Bar")
					.on("click", animateToStackedView);

				buttonContainer
					.append("div")
					.attr("id", "paretoStageLabel")
					.style("font-weight", "600")
					.style("font-size", "14px")
					.style("color", "#667eea")
					.style("margin", "0 10px")
					.text("Current View: Stacked Bar");

				// Initialize Stage 1
				renderStage1();
			}

			function animateToParetoView() {
				if (paretoStage !== 0) return; // Already in Pareto view or animating

				d3.select("#paretoStageLabel").text("Animating to Pareto Chart...");

				// Disable buttons during animation
				d3.select("#paretoViewBtn").attr("disabled", true).style("opacity", 0.5);
				d3.select("#stackedViewBtn").attr("disabled", true).style("opacity", 0.5);

				// Chain animations with delays
				setTimeout(() => {
					paretoStage = 1;
					renderStage2(); // Push bars horizontally to correct X positions (still stacked vertically)
				}, 800);

				setTimeout(() => {
					paretoStage = 2;
					renderStage3(); // Drop bars down to Y=0 baseline
				}, 3200);

				setTimeout(() => {
					paretoStage = 3;
					renderStage4(); // Sort descending
				}, 5400);

				setTimeout(() => {
					paretoStage = 4;
					renderStage5(); // Add Pareto line
				}, 7900);

				setTimeout(() => {
					paretoStage = 5;
					renderStage6(); // Final styling
					d3.select("#paretoStageLabel").text("Current View: Pareto Chart");

					// Re-enable buttons
					d3.select("#paretoViewBtn").attr("disabled", null).style("opacity", 1);
					d3.select("#stackedViewBtn").attr("disabled", null).style("opacity", 1);
				}, 11900);
			}

			function animateToStackedView() {
				if (paretoStage !== 5) return; // Not in Pareto view

				d3.select("#paretoStageLabel").text("Returning to Stacked Bar...");

				// Disable buttons during animation
				d3.select("#paretoViewBtn").attr("disabled", true).style("opacity", 0.5);
				d3.select("#stackedViewBtn").attr("disabled", true).style("opacity", 0.5);

				// Reverse animation sequence
				setTimeout(() => {
					paretoStage = 4;
					renderStage7(); // Remove styling, prepare for reverse
				}, 800);

				setTimeout(() => {
					paretoStage = 3;
					renderStage8(); // Unsort bars
				}, 3000);

				setTimeout(() => {
					paretoStage = 2;
					renderStage9(); // Lift bars back to stacked Y positions
				}, 5500);

				setTimeout(() => {
					paretoStage = 1;
					renderStage10(); // Merge horizontally back to center
				}, 7700);

				setTimeout(() => {
					paretoStage = 0;
					d3.select("#paretoStageLabel").text("Current View: Stacked Bar");

					// Re-enable buttons
					d3.select("#paretoViewBtn").attr("disabled", null).style("opacity", 1);
					d3.select("#stackedViewBtn").attr("disabled", null).style("opacity", 1);
				}, 10700);
			}

			// ============================================
			// STAGE 1: Stacked Bar
			// ============================================
			function renderStage1() {
				paretoG.selectAll("*").remove();

				// Single stacked bar position
				const stackX = paretoWidth / 2 - 40;
				const stackWidth = 80;

				// Y scale for income share
				paretoYScaleLeft = d3
					.scaleLinear()
					.domain([0, 100])
					.range([paretoHeight, 0]);

				// Add left Y axis
				paretoG
					.append("g")
					.attr("class", "y-axis-left")
					.call(d3.axisLeft(paretoYScaleLeft).tickFormat((d) => d + "%"))
					.selectAll("text")
					.style("font-size", "12px")
					.style("fill", "#667eea");

				// Y axis label
				paretoG
					.append("text")
					.attr("class", "y-label")
					.attr("transform", "rotate(-90)")
					.attr("y", -60)
					.attr("x", -paretoHeight / 2)
					.attr("text-anchor", "middle")
					.style("font-size", "13px")
					.style("font-weight", "700")
					.style("fill", "#667eea")
					.text("Income Share (%)");

				// Add X axis (single category for stacked bar)
				paretoG
					.append("g")
					.attr("class", "x-axis-stacked")
					.attr("transform", `translate(0,${paretoHeight})`)
					.append("line")
					.attr("x1", 0)
					.attr("x2", paretoWidth)
					.attr("stroke", "#ccc")
					.attr("stroke-width", 1);

				// X axis label for stacked view
				paretoG
					.append("text")
					.attr("class", "x-label-stacked")
					.attr("x", paretoWidth / 2)
					.attr("y", paretoHeight + 50)
					.attr("text-anchor", "middle")
					.style("font-size", "13px")
					.style("font-weight", "700")
					.style("fill", "#333")
					.text("All Income Deciles (Bottom 10% ‚Üí Top 10%)");

				// Title
				paretoG
					.append("text")
					.attr("class", "chart-title")
					.attr("x", paretoWidth / 2)
					.attr("y", -50)
					.attr("text-anchor", "middle")
					.style("font-size", "18px")
					.style("font-weight", "700")
					.style("fill", "#6A5ACD")
					.text("US Income Distribution (Stacked Decile Share)");

				// Color scale
				const colorScale = d3
					.scaleSequential()
					.domain([0, paretoData.length - 1])
					.interpolator(d3.interpolateRgb("#10b981", "#6FA8DC"));

				// Calculate cumulative positions for stacking
				let yOffset = 0;
				const stackedData = paretoData.map((d, i) => {
					const y = yOffset;
					yOffset += d.share;
					return { ...d, stackY: y };
				});

				// Draw stacked segments
				paretoG
					.selectAll(".stack-segment")
					.data(stackedData)
					.enter()
					.append("rect")
					.attr("class", "stack-segment")
					.attr("x", stackX)
					.attr("width", stackWidth)
					.attr("y", paretoHeight)
					.attr("height", 0)
					.attr("fill", (d, i) => colorScale(i))
					.attr("stroke", "#fff")
					.attr("stroke-width", 2)
					.transition()
					.delay((d, i) => i * 120)
					.duration(900)
					.ease(d3.easeCubicOut)
					.attr("y", (d) => paretoYScaleLeft(d.stackY + d.share))
					.attr(
						"height",
						(d) => paretoYScaleLeft(d.stackY) - paretoYScaleLeft(d.stackY + d.share)
					);
			}

			// ============================================
			// STAGE 2: Push Bars Horizontally to Correct X Positions (Still Stacked)
			// ============================================
			function renderStage2() {
				paretoG
					.selectAll(".chart-title")
					.transition()
					.duration(600)
					.text("Positioning Deciles...");

				// Remove stacked bar X-axis elements
				paretoG
					.selectAll(".x-axis-stacked")
					.transition()
					.duration(600)
					.style("opacity", 0)
					.remove();
				paretoG
					.selectAll(".x-label-stacked")
					.transition()
					.duration(600)
					.style("opacity", 0)
					.remove();

				// Create band scale for side-by-side bars
				paretoXScale = d3
					.scaleBand()
					.domain(paretoData.map((d) => d.decile))
					.range([0, paretoWidth])
					.padding(0.2);

				// Add X axis (but keep it invisible for now)
				paretoG
					.append("g")
					.attr("class", "x-axis")
					.attr("transform", `translate(0,${paretoHeight})`)
					.style("opacity", 0)
					.call(d3.axisBottom(paretoXScale))
					.selectAll("text")
					.attr("transform", "rotate(-45)")
					.attr("dy", "0.5em")
					.attr("dx", "-0.8em")
					.style("text-anchor", "end")
					.style("font-size", "10px")
					.style("font-weight", "600")
					.style("fill", "#333");

				// Calculate cumulative positions for stacking (same as stage 1)
				let yOffset = 0;
				const stackedData = paretoData.map((d, i) => {
					const y = yOffset;
					yOffset += d.share;
					return { ...d, stackY: y };
				});

				// Keep Y scale the same as stacked view
				paretoYScaleLeft = d3
					.scaleLinear()
					.domain([0, 100])
					.range([paretoHeight, 0]);

				// Transition segments horizontally to their X positions, but keep stacked Y positions
				paretoG
					.selectAll(".stack-segment")
					.data(stackedData, (d) => d.decile)
					.transition()
					.duration(1500)
					.ease(d3.easeCubicInOut)
					.attr("x", (d) => paretoXScale(d.decile))
					.attr("width", paretoXScale.bandwidth())
					// Keep stacked Y positions - don't change Y or height yet
					.attr("y", (d) => paretoYScaleLeft(d.stackY + d.share))
					.attr(
						"height",
						(d) => paretoYScaleLeft(d.stackY) - paretoYScaleLeft(d.stackY + d.share)
					);
			}

			// ============================================
			// STAGE 3: Drop Bars Down to Y=0 Baseline
			// ============================================
			function renderStage3() {
				paretoG
					.select(".chart-title")
					.transition()
					.duration(600)
					.text("US Income Share by Decile");

				// Update Y scale for individual bars (not stacked)
				paretoYScaleLeft = d3
					.scaleLinear()
					.domain([0, d3.max(paretoData, (d) => d.share) * 1.1])
					.range([paretoHeight, 0]);

				// Update Y axis
				paretoG
					.select(".y-axis-left")
					.transition()
					.duration(1200)
					.ease(d3.easeCubicInOut)
					.call(d3.axisLeft(paretoYScaleLeft).tickFormat((d) => d + "%"));

				// Show X axis now
				paretoG
					.select(".x-axis")
					.transition()
					.duration(1200)
					.ease(d3.easeCubicInOut)
					.style("opacity", 1);

				// Drop bars down to baseline (Y=0), each bar shows only its own share
				paretoG
					.selectAll(".stack-segment")
					.data(paretoData, (d) => d.decile)
					.transition()
					.duration(1500)
					.ease(d3.easeCubicInOut)
					.attr("y", (d) => paretoYScaleLeft(d.share))
					.attr("height", (d) => paretoHeight - paretoYScaleLeft(d.share));
			}

			// ============================================
			// STAGE 4: Sort Bars Descending
			// ============================================
			function renderStage4() {
				paretoG
					.select(".chart-title")
					.transition()
					.duration(600)
					.text("US Income Share by Decile (Sorted)");

				// Sort data by share descending
				const sortedData = [...paretoData].sort((a, b) => b.share - a.share);

				// Update X scale with sorted domain
				paretoXScale.domain(sortedData.map((d) => d.decile));

				// Update X axis
				paretoG
					.select(".x-axis")
					.transition()
					.duration(1200)
					.ease(d3.easeCubicInOut)
					.call(d3.axisBottom(paretoXScale))
					.selectAll("text")
					.attr("transform", "rotate(-45)")
					.attr("dy", "0.5em")
					.attr("dx", "-0.8em")
					.style("text-anchor", "end");

				// New color scale (gradient from green to blue)
				const newColorScale = d3
					.scaleLinear()
					.domain([0, d3.max(sortedData, (d) => d.share)])
					.range(["#4B8BBE", "#6FA8DC"])
					.interpolate(d3.interpolateRgb);

				// Transition bars to new positions and colors
				paretoG
					.selectAll(".stack-segment")
					.data(sortedData, (d) => d.decile)
					.transition()
					.duration(1400)
					.ease(d3.easeCubicInOut)
					.attr("x", (d) => paretoXScale(d.decile))
					.attr("fill", (d) => newColorScale(d.share));

				// Add percentage labels
				paretoG
					.selectAll(".bar-label")
					.data(sortedData, (d) => d.decile)
					.join("text")
					.attr("class", "bar-label")
					.attr("x", (d) => paretoXScale(d.decile) + paretoXScale.bandwidth() / 2)
					.attr("y", (d) => paretoYScaleLeft(d.share) + 20)
					.attr("text-anchor", "middle")
					.style("font-size", "11px")
					.style("font-weight", "700")
					.style("fill", "#fff")
					.style("opacity", 0)
					.text((d) => d.share.toFixed(1) + "%")
					.transition()
					.delay(800)
					.duration(800)
					.style("opacity", 1);
			}

			// ============================================
			// STAGE 5: Overlay Pareto Line
			// ============================================
			function renderStage5() {
				paretoG
					.select(".chart-title")
					.transition()
					.duration(600)
					.text("US Income Distribution: Pareto Analysis");

				const sortedData = [...paretoData].sort((a, b) => b.share - a.share);

				// Add right Y axis for cumulative %
				paretoYScaleRight = d3
					.scaleLinear()
					.domain([0, 100])
					.range([paretoHeight, 0]);

				paretoG
					.append("g")
					.attr("class", "y-axis-right")
					.attr("transform", `translate(${paretoWidth},0)`)
					.style("opacity", 0)
					.call(d3.axisRight(paretoYScaleRight).tickFormat((d) => d + "%"))
					.selectAll("text")
					.style("font-size", "12px")
					.style("fill", "#DAA520");

				paretoG
					.select(".y-axis-right")
					.transition()
					.duration(1000)
					.ease(d3.easeCubicInOut)
					.style("opacity", 1);

				// Right Y axis label
				paretoG
					.append("text")
					.attr("class", "y-label-right")
					.attr("transform", "rotate(-90)")
					.attr("y", paretoWidth + 80)
					.attr("x", -paretoHeight / 2)
					.attr("text-anchor", "middle")
					.style("font-size", "13px")
					.style("font-weight", "700")
					.style("fill", "#DAA520")
					.style("opacity", 0)
					.text("Cumulative %")
					.transition()
					.duration(1000)
					.ease(d3.easeCubicInOut)
					.style("opacity", 1);

				// Draw Pareto line
				const lineGenerator = d3
					.line()
					.x((d) => paretoXScale(d.decile) + paretoXScale.bandwidth() / 2)
					.y((d) => paretoYScaleRight(d.cumulative))
					.curve(d3.curveMonotoneX);

				const linePath = paretoG
					.append("path")
					.datum(sortedData)
					.attr("class", "pareto-line")
					.attr("fill", "none")
					.attr("stroke", "#DAA520")
					.attr("stroke-width", 3)
					.attr("d", lineGenerator);

				// Animate line with stroke-dasharray
				const lineLength = linePath.node().getTotalLength();
				linePath
					.attr("stroke-dasharray", lineLength + " " + lineLength)
					.attr("stroke-dashoffset", lineLength)
					.transition()
					.delay(1200)
					.duration(2500)
					.ease(d3.easeLinear)
					.attr("stroke-dashoffset", 0);

				// Add dots on line
				paretoG
					.selectAll(".pareto-dot")
					.data(sortedData, (d) => d.decile)
					.join("circle")
					.attr("class", "pareto-dot")
					.attr("cx", (d) => paretoXScale(d.decile) + paretoXScale.bandwidth() / 2)
					.attr("cy", (d) => paretoYScaleRight(d.cumulative))
					.attr("r", 0)
					.attr("fill", "#DAA520")
					.attr("stroke", "#fff")
					.attr("stroke-width", 2)
					.transition()
					.delay((d, i) => 3700 + i * 100)
					.duration(400)
					.ease(d3.easeBackOut)
					.attr("r", 6);
			}

			// ============================================
			// STAGE 6: Final Styling
			// ============================================
			function renderStage6() {
				// Add legend
				const legend = paretoG
					.append("g")
					.attr("class", "legend")
					.attr("transform", `translate(10, -60)`);

				legend
					.append("rect")
					.attr("x", 0)
					.attr("y", 0)
					.attr("width", 20)
					.attr("height", 20)
					.attr("fill", "#6FA8DC")
					.attr("stroke", "#fff")
					.attr("stroke-width", 2)
					.style("opacity", 0)
					.transition()
					.duration(800)
					.style("opacity", 1);

				legend
					.append("text")
					.attr("x", 28)
					.attr("y", 15)
					.style("font-size", "12px")
					.style("font-weight", "600")
					.style("fill", "#333")
					.style("opacity", 0)
					.text("Income Share (bars)")
					.transition()
					.duration(800)
					.style("opacity", 1);

				legend
					.append("line")
					.attr("x1", 200)
					.attr("y1", 10)
					.attr("x2", 220)
					.attr("y2", 10)
					.attr("stroke", "#DAA520")
					.attr("stroke-width", 3)
					.style("opacity", 0)
					.transition()
					.delay(400)
					.duration(800)
					.style("opacity", 1);

				legend
					.append("circle")
					.attr("cx", 210)
					.attr("cy", 10)
					.attr("r", 5)
					.attr("fill", "#DAA520")
					.attr("stroke", "#fff")
					.attr("stroke-width", 2)
					.style("opacity", 0)
					.transition()
					.delay(400)
					.duration(800)
					.style("opacity", 1);

				legend
					.append("text")
					.attr("x", 228)
					.attr("y", 15)
					.style("font-size", "12px")
					.style("font-weight", "600")
					.style("fill", "#333")
					.style("opacity", 0)
					.text("Cumulative % (line)")
					.transition()
					.delay(400)
					.duration(800)
					.style("opacity", 1);

				// Add hover interactions
				const sortedData = [...paretoData].sort((a, b) => b.share - a.share);

				paretoG
					.selectAll(".stack-segment")
					.on("mouseover", function (event, d) {
						d3
							.select(this)
							.transition()
							.duration(200)
							.attr("opacity", 0.7)
							.attr("stroke-width", 4);
						tooltip
							.classed("show", true)
							.html(
								`<div class="tooltip-title">${d.decile}</div>
								<div class="tooltip-row"><span class="tooltip-label">Income Share:</span><span class="tooltip-value">${d.share.toFixed(
									1
								)}%</span></div>
								<div class="tooltip-row"><span class="tooltip-label">Cumulative:</span><span class="tooltip-value">${d.cumulative.toFixed(
									1
								)}%</span></div>`
							)
							.style("left", event.pageX + 15 + "px")
							.style("top", event.pageY - 28 + "px");
					})
					.on("mouseout", function () {
						d3
							.select(this)
							.transition()
							.duration(200)
							.attr("opacity", 1)
							.attr("stroke-width", 2);
						tooltip.classed("show", false);
					});

				paretoG
					.selectAll(".pareto-dot")
					.on("mouseover", function (event, d) {
						d3
							.select(this)
							.transition()
							.duration(200)
							.attr("r", 9)
							.attr("stroke-width", 3);
						tooltip
							.classed("show", true)
							.html(
								`<div class="tooltip-title">${d.decile}</div>
							<div class="tooltip-row"><span class="tooltip-label">Cumulative Share:</span><span class="tooltip-value">${d.cumulative.toFixed(
								1
							)}%</span></div>
							<div class="tooltip-row"><span class="tooltip-label">This Decile:</span><span class="tooltip-value">${d.share.toFixed(
								1
							)}%</span></div>`
							)
							.style("left", event.pageX + 15 + "px")
							.style("top", event.pageY - 28 + "px");
					})
					.on("mouseout", function () {
						d3
							.select(this)
							.transition()
							.duration(200)
							.attr("r", 6)
							.attr("stroke-width", 2);
						tooltip.classed("show", false);
					});
			}

			// ============================================
			// STAGE 7: Reverse - Remove Pareto Elements
			// ============================================
			function renderStage7() {
				paretoG
					.select(".chart-title")
					.transition()
					.duration(600)
					.text("Removing Pareto Elements...");

				// Fade out and remove line and dots
				paretoG
					.select(".pareto-line")
					.transition()
					.duration(1000)
					.ease(d3.easeCubicInOut)
					.style("opacity", 0)
					.remove();
				paretoG
					.selectAll(".pareto-dot")
					.transition()
					.duration(1000)
					.ease(d3.easeCubicInOut)
					.attr("r", 0)
					.remove();
				paretoG
					.select(".y-axis-right")
					.transition()
					.duration(1000)
					.ease(d3.easeCubicInOut)
					.style("opacity", 0)
					.remove();
				paretoG
					.select(".y-label-right")
					.transition()
					.duration(1000)
					.ease(d3.easeCubicInOut)
					.style("opacity", 0)
					.remove();
				paretoG
					.select(".legend")
					.transition()
					.duration(1000)
					.ease(d3.easeCubicInOut)
					.style("opacity", 0)
					.remove();
				paretoG
					.selectAll(".bar-label")
					.transition()
					.duration(1000)
					.ease(d3.easeCubicInOut)
					.style("opacity", 0)
					.remove();

				// Remove hover interactions
				paretoG
					.selectAll(".stack-segment")
					.on("mouseover", null)
					.on("mouseout", null);
			}

			// ============================================
			// STAGE 8: Unsort Bars
			// ============================================
			function renderStage8() {
				paretoG
					.select(".chart-title")
					.transition()
					.duration(600)
					.text("Returning to Original Order...");

				// Revert to original order
				const originalOrder = [...paretoData];
				paretoXScale.domain(originalOrder.map((d) => d.decile));

				// Update X axis
				paretoG
					.select(".x-axis")
					.transition()
					.duration(1200)
					.ease(d3.easeCubicInOut)
					.call(d3.axisBottom(paretoXScale))
					.selectAll("text")
					.attr("transform", "rotate(-45)")
					.attr("dy", "0.5em")
					.attr("dx", "-0.8em")
					.style("text-anchor", "end");

				// Original color scale
				const originalColorScale = d3
					.scaleSequential()
					.domain([0, paretoData.length - 1])
					.interpolator(d3.interpolateRgb("#10b981", "#6FA8DC"));

				// Transition bars back to original positions and colors
				paretoG
					.selectAll(".stack-segment")
					.data(originalOrder, (d) => d.decile)
					.transition()
					.duration(1400)
					.ease(d3.easeCubicInOut)
					.attr("x", (d) => paretoXScale(d.decile))
					.attr("fill", (d, i) => originalColorScale(i));
			}

			// ============================================
			// STAGE 9: Lift Bars Back to Stacked Y Positions
			// ============================================
			function renderStage9() {
				paretoG
					.select(".chart-title")
					.transition()
					.duration(600)
					.text("Lifting to Stacked Positions...");

				// Fade out X axis (will be hidden but bars stay at their X positions)
				paretoG
					.select(".x-axis")
					.transition()
					.duration(1000)
					.ease(d3.easeCubicInOut)
					.style("opacity", 0);

				// Calculate cumulative positions for stacking
				let yOffset = 0;
				const stackedData = paretoData.map((d, i) => {
					const y = yOffset;
					yOffset += d.share;
					return { ...d, stackY: y };
				});

				// Update Y scale back to 100% stacked scale
				paretoYScaleLeft.domain([0, 100]);
				paretoG
					.select(".y-axis-left")
					.transition()
					.duration(1200)
					.ease(d3.easeCubicInOut)
					.call(d3.axisLeft(paretoYScaleLeft).tickFormat((d) => d + "%"));

				// Lift bars up to their stacked Y positions (but keep their current X positions)
				paretoG
					.selectAll(".stack-segment")
					.data(stackedData, (d) => d.decile)
					.transition()
					.duration(1500)
					.ease(d3.easeCubicInOut)
					.attr("y", (d) => paretoYScaleLeft(d.stackY + d.share))
					.attr(
						"height",
						(d) => paretoYScaleLeft(d.stackY) - paretoYScaleLeft(d.stackY + d.share)
					);
			}

			// ============================================
			// STAGE 10: Merge Horizontally Back to Center
			// ============================================
			function renderStage10() {
				paretoG
					.select(".chart-title")
					.transition()
					.duration(600)
					.text("US Income Distribution (Stacked Decile Share)");

				// Remove the X axis completely
				paretoG
					.select(".x-axis")
					.transition()
					.duration(600)
					.ease(d3.easeCubicInOut)
					.style("opacity", 0)
					.remove();

				// Merge bars back to center stacked position
				const stackX = paretoWidth / 2 - 40;
				const stackWidth = 80;

				let yOffset = 0;
				const stackedData = paretoData.map((d, i) => {
					const y = yOffset;
					yOffset += d.share;
					return { ...d, stackY: y };
				});

				// Re-add X axis for stacked view
				paretoG
					.append("g")
					.attr("class", "x-axis-stacked")
					.attr("transform", `translate(0,${paretoHeight})`)
					.style("opacity", 0)
					.append("line")
					.attr("x1", 0)
					.attr("x2", paretoWidth)
					.attr("stroke", "#ccc")
					.attr("stroke-width", 1);

				paretoG
					.select(".x-axis-stacked")
					.transition()
					.delay(800)
					.duration(800)
					.style("opacity", 1);

				// Re-add X axis label
				paretoG
					.append("text")
					.attr("class", "x-label-stacked")
					.attr("x", paretoWidth / 2)
					.attr("y", paretoHeight + 50)
					.attr("text-anchor", "middle")
					.style("font-size", "13px")
					.style("font-weight", "700")
					.style("fill", "#333")
					.style("opacity", 0)
					.text("All Income Deciles (Bottom 10% ‚Üí Top 10%)")
					.transition()
					.delay(800)
					.duration(800)
					.style("opacity", 1);

				// Move bars horizontally back to center
				paretoG
					.selectAll(".stack-segment")
					.data(stackedData, (d) => d.decile)
					.transition()
					.duration(1600)
					.ease(d3.easeCubicInOut)
					.attr("x", stackX)
					.attr("width", stackWidth)
					.attr("fill", (d, i) =>
						d3.interpolateRgb("#10b981", "#6FA8DC")(i / (stackedData.length - 1))
					);
			}

			// ============================================
			// UTILITY FUNCTIONS
			// ============================================

			function getCountryCode(feature) {
				// Comprehensive map of GeoJSON numeric IDs to ISO3 codes
				const idToCode = {
					"004": "AFG",
					"008": "ALB",
					"012": "DZA",
					"016": "ASM",
					"020": "AND",
					"024": "AGO",
					"028": "ATG",
					"031": "AZE",
					"032": "ARG",
					"036": "AUS",
					"040": "AUT",
					"044": "BHS",
					"048": "BHR",
					"050": "BGD",
					"051": "ARM",
					"052": "BRB",
					"056": "BEL",
					"060": "BMU",
					"064": "BTN",
					"068": "BOL",
					"070": "BIH",
					"072": "BWA",
					"076": "BRA",
					"084": "BLZ",
					"090": "SLB",
					"096": "BRN",
					100: "BGR",
					104: "MMR",
					108: "BDI",
					112: "BLR",
					116: "KHM",
					120: "CMR",
					124: "CAN",
					132: "CPV",
					136: "CYM",
					140: "CAF",
					144: "LKA",
					148: "TCD",
					152: "CHL",
					156: "CHN",
					170: "COL",
					174: "COM",
					178: "COG",
					180: "COD",
					188: "CRI",
					191: "HRV",
					192: "CUB",
					196: "CYP",
					203: "CZE",
					204: "BEN",
					208: "DNK",
					212: "DMA",
					214: "DOM",
					218: "ECU",
					222: "SLV",
					226: "GNQ",
					231: "ETH",
					232: "ERI",
					233: "EST",
					242: "FJI",
					246: "FIN",
					250: "FRA",
					258: "PYF",
					262: "DJI",
					266: "GAB",
					268: "GEO",
					270: "GMB",
					275: "PSE",
					276: "DEU",
					288: "GHA",
					296: "KIR",
					300: "GRC",
					308: "GRD",
					320: "GTM",
					324: "GIN",
					328: "GUY",
					332: "HTI",
					336: "VAT",
					340: "HND",
					348: "HUN",
					352: "ISL",
					356: "IND",
					360: "IDN",
					364: "IRN",
					368: "IRQ",
					372: "IRL",
					376: "ISR",
					380: "ITA",
					384: "CIV",
					388: "JAM",
					392: "JPN",
					398: "KAZ",
					400: "JOR",
					404: "KEN",
					408: "PRK",
					410: "KOR",
					414: "KWT",
					417: "KGZ",
					418: "LAO",
					422: "LBN",
					426: "LSO",
					428: "LVA",
					430: "LBR",
					434: "LBY",
					438: "LIE",
					440: "LTU",
					442: "LUX",
					450: "MDG",
					454: "MWI",
					458: "MYS",
					462: "MDV",
					466: "MLI",
					470: "MLT",
					478: "MRT",
					480: "MUS",
					484: "MEX",
					492: "MCO",
					496: "MNG",
					498: "MDA",
					499: "MNE",
					504: "MAR",
					508: "MOZ",
					512: "OMN",
					516: "NAM",
					520: "NRU",
					524: "NPL",
					528: "NLD",
					554: "NZL",
					558: "NIC",
					562: "NER",
					566: "NGA",
					578: "NOR",
					583: "FSM",
					586: "PAK",
					591: "PAN",
					598: "PNG",
					600: "PRY",
					604: "PER",
					608: "PHL",
					616: "POL",
					620: "PRT",
					624: "GNB",
					626: "TLS",
					634: "QAT",
					642: "ROU",
					643: "RUS",
					646: "RWA",
					662: "LCA",
					670: "VCT",
					674: "SMR",
					678: "STP",
					682: "SAU",
					686: "SEN",
					688: "SRB",
					690: "SYC",
					694: "SLE",
					702: "SGP",
					703: "SVK",
					704: "VNM",
					705: "SVN",
					706: "SOM",
					710: "ZAF",
					716: "ZWE",
					724: "ESP",
					728: "SSD",
					729: "SDN",
					740: "SUR",
					748: "SWZ",
					752: "SWE",
					756: "CHE",
					760: "SYR",
					762: "TJK",
					764: "THA",
					768: "TGO",
					776: "TON",
					780: "TTO",
					784: "ARE",
					788: "TUN",
					792: "TUR",
					795: "TKM",
					798: "TUV",
					800: "UGA",
					804: "UKR",
					807: "MKD",
					818: "EGY",
					826: "GBR",
					834: "TZA",
					840: "USA",
					854: "BFA",
					858: "URY",
					860: "UZB",
					862: "VEN",
					876: "WLF",
					882: "WSM",
					887: "YEM",
					894: "ZMB",
				};

				return idToCode[feature.id] || feature.id;
			}

			// Clean up intervals on page unload
			window.addEventListener("beforeunload", () => {
				if (globalPlayInterval) clearInterval(globalPlayInterval);
				if (top5PlayInterval) clearInterval(top5PlayInterval);
				if (giniGlobalPlayInterval) clearInterval(giniGlobalPlayInterval);
				if (giniTop5PlayInterval) clearInterval(giniTop5PlayInterval);
				if (headcountGlobalPlayInterval) clearInterval(headcountGlobalPlayInterval);
				if (headcountTop5PlayInterval) clearInterval(headcountTop5PlayInterval);
				if (scatterPlayInterval) clearInterval(scatterPlayInterval);
			});
		</script>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			// Enable multi-level dropdown on hover for desktop
			document.addEventListener("DOMContentLoaded", function () {
				const dropdownSubmenus = document.querySelectorAll(".dropdown-submenu");

				dropdownSubmenus.forEach(function (submenu) {
					submenu.addEventListener("mouseenter", function () {
						// Check if submenu would go off-screen
						const dropdownMenu = this.querySelector(".dropdown-menu");
						if (dropdownMenu) {
							dropdownMenu.classList.add("show");

							// Check if it extends beyond viewport
							const rect = dropdownMenu.getBoundingClientRect();
							const viewportWidth = window.innerWidth;

							if (rect.right > viewportWidth) {
								// Flip to left side
								this.classList.add("dropstart");
							} else {
								this.classList.remove("dropstart");
							}
						}
					});

					submenu.addEventListener("mouseleave", function () {
						const dropdownMenu = this.querySelector(".dropdown-menu");
						if (dropdownMenu) {
							dropdownMenu.classList.remove("show");
						}
					});
				});
			});
		</script>
	</body>
</html>
